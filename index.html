<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HRG PC Builder — Private PCPartPicker</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151823; --muted:#2a3042; --text:#e6e9ef; --sub:#aab1c4; --brand:#7aa2ff; --good:#45d483; --warn:#ffc857; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(180deg,#0b0d12 0%,#0f1115 60%);color:var(--text)}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:16px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:980px){.grid.cols-3,.grid.cols-2{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--muted);border-radius:16px;padding:18px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    h1{font-size:28px;margin:0 0 8px}
    h2{font-size:18px;margin:0 0 8px;color:var(--sub)}
    label{display:block;font-size:13px;color:var(--sub);margin-bottom:6px}
    select,input,button{background:#0e111a;color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:10px 12px}
    input[type="range"]{width:100%}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--muted);background:#0d1018;color:var(--sub);font-size:12px}
    .tag{padding:2px 8px;border-radius:999px;background:#0d141f;border:1px solid var(--muted);color:var(--brand);font-size:11px;margin-left:8px}
    .btn{cursor:pointer;transition:.15s transform ease, .15s background ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg,#4c6fff,#7aa2ff);border-color:#5f7cff}
    .btn.ghost{background:#0d1018}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{flex:1;min-width:160px;padding:12px 14px;border-radius:12px;background:#0c111a;border:1px dashed var(--muted)}
    .kpi .label{font-size:12px;color:var(--sub)}
    .kpi .value{font-size:18px;font-weight:600;margin-top:4px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px 12px;text-align:left;font-size:14px}
    thead th{color:var(--sub);font-weight:500}
    tbody tr{background:#0c111a;border:1px solid var(--muted)}
    tbody tr td{border-top:1px solid var(--muted);border-bottom:1px solid var(--muted)}
    tbody tr td:first-child{border-left:1px solid var(--muted);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-right:1px solid var(--muted);border-top-right-radius:10px;border-bottom-right-radius:10px}
    .status{font-size:12px}
    .status.good{color:var(--good)}
    .status.warn{color:var(--warn)}
    .status.bad{color:var(--bad)}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .muted{color:var(--sub)}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#2a3042,transparent);margin:16px 0}
    .tiny{font-size:11px;color:var(--sub)}
    .sticky-actions{position:sticky;bottom:0;padding:10px;background:linear-gradient(180deg,transparent,rgba(15,17,21,.9) 35%);backdrop-filter:blur(4px)}
  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <div class="row" style="align-items:flex-start">
        <div style="flex:2">
          <h1>HRG PC Builder <span class="tag mono">alpha</span></h1>
          <div class="muted">Private PCPartPicker for Howard Resource Group — tier-aware, budget-driven, with live pricing hooks.</div>
        </div>
        <div class="row" style="flex:1;justify-content:flex-end">
          <button id="btnExportCSV" class="btn ghost">Export CSV</button>
          <button id="btnSaveLocal" class="btn ghost">Download Build (.json)</button>
          <button id="btnLoadLocal" class="btn ghost">Load Build</button>
          <button id="btnRefreshPrices" class="btn primary">Refresh Prices</button>
        </div>
      </div>
    </header>

    <section class="grid cols-3">
      <div class="card">
        <label for="tierSelect">Tier</label>
        <select id="tierSelect"></select>
        <div id="tierDesc" class="tiny" style="margin-top:8px"></div>
        <div style="margin-top:10px" class="tiny">Eligibility: <span id="tierEligibility" class="pill">—</span></div>
      </div>

      <div class="card">
        <label for="budgetRange">Budget</label>
        <div class="row">
          <input id="budgetRange" type="range" min="600" max="7000" step="50" />
          <input id="budgetInput" type="number" min="300" max="10000" step="50" />
        </div>
        <div class="kpis" style="margin-top:10px">
          <div class="kpi"><div class="label">Allocated to CPU</div><div class="value" id="kpiCPU">—</div></div>
          <div class="kpi"><div class="label">Allocated to GPU</div><div class="value" id="kpiGPU">—</div></div>
          <div class="kpi"><div class="label">Headroom (PSU/Cooling)</div><div class="value" id="kpiHead">—</div></div>
        </div>
      </div>

      <div class="card">
        <div class="grid cols-2">
          <div>
            <label for="markupPct">Markup %</label>
            <input id="markupPct" type="number" min="0" max="50" step="0.5" value="12" />
          </div>
          <div>
            <label for="assemblyFee">Assembly Fee ($)</label>
            <input id="assemblyFee" type="number" min="0" step="10" value="150" />
          </div>
          <div>
            <label for="taxPct">Sales Tax %</label>
            <input id="taxPct" type="number" min="0" step="0.1" value="0" />
          </div>
          <div>
            <label for="pricingMode">Pricing Mode</label>
            <select id="pricingMode">
              <option value="live">Live (cached ≤24h)</option>
              <option value="cached" selected>Cached (Firestore)</option>
              <option value="manual">Manual / Demo Data</option>
            </select>
          </div>
        </div>
        <div class="tiny" style="margin-top:8px">Markup is applied to parts subtotal (not tax). Assembly fee added post‑markup.</div>
      </div>
    </section>

    <section class="card">
      <h2>Requirements</h2>
      <div class="row">
        <label class="pill"><input id="reqWifi" type="checkbox" checked> Wi‑Fi</label>
        <label class="pill"><input id="reqRGB" type="checkbox"> RGB Preference</label>
        <label class="pill"><input id="reqLiquid" type="checkbox"> Liquid Cooling</label>
        <label class="pill"><input id="reqSFF" type="checkbox"> Small Form Factor</label>
        <label class="pill"><input id="reqSilent" type="checkbox"> Quiet / Low Noise</label>
        <label class="pill"><input id="reqNvme" type="checkbox" checked> NVMe Boot</label>
      </div>
    </section>

    <section class="card">
      <h2>Suggested Build</h2>
      <div class="divider"></div>
      <table>
        <thead>
          <tr>
            <th style="width:18%">Category</th>
            <th>Part</th>
            <th style="width:12%">Price</th>
            <th style="width:14%">Compat</th>
            <th style="width:16%">Notes</th>
          </tr>
        </thead>
        <tbody id="buildRows"></tbody>
      </table>

      <div class="divider"></div>
      <div class="kpis">
        <div class="kpi"><div class="label">Parts Subtotal</div><div class="value" id="kpiParts">—</div></div>
        <div class="kpi"><div class="label">+ Markup</div><div class="value" id="kpiMarkup">—</div></div>
        <div class="kpi"><div class="label">+ Assembly</div><div class="value" id="kpiAssembly">—</div></div>
        <div class="kpi"><div class="label">Pre‑Tax Total</div><div class="value" id="kpiPretax">—</div></div>
        <div class="kpi"><div class="label">+ Tax</div><div class="value" id="kpiTax">—</div></div>
        <div class="kpi"><div class="label">Out‑the‑Door</div><div class="value" id="kpiOtd">—</div></div>
      </div>

      <div class="sticky-actions row" style="justify-content:flex-end;margin-top:10px">
        <button id="btnAutoBuild" class="btn primary">Auto‑Build from Tier + Budget</button>
      </div>
    </section>

    <section class="card">
      <h2>Data & Integrations</h2>
      <div class="tiny">This page can use <strong>Firestore</strong> for cached pricing and a Cloud Function that synchronizes with PCPartPicker / vendors. Fill your config below.</div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Firebase Config (paste yours)</label>
          <textarea id="fbConfig" rows="6" style="width:100%;background:#0e111a;color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:10px" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
          <div class="row" style="margin-top:8px"><button id="btnInitFb" class="btn ghost">Init Firebase</button><span id="fbStatus" class="tiny">Not initialized.</span></div>
        </div>
        <div>
          <label>Cloud Function Endpoint (price sync proxy)</label>
          <input id="fnEndpoint" placeholder="https://YOUR_REGION-YOUR_PROJECT.cloudfunctions.net/priceSync" />
          <div class="tiny" style="margin-top:6px">Expected GET/POST signature: <span class="mono">/priceSync?sku=RTX_4080_SUPER</span> or <span class="mono">/priceSync?category=gpu</span>. Returns JSON with <span class="mono">price_usd, vendor, url, updated_at</span>.</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase SDKs (compat for ease). Remove if you bundle elsewhere. -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  /**************
   * Tier Model *
   **************/
  const TIERS = [
    { id:1, key:'sff_king', name:'SFF King', desc:'Small, durable, portable, efficient.', badge:'SFF', budget:[1200,4000], alloc:{cpu:.26,gpu:.34,mb:.10,ram:.07,storage:.10,psu:.07,cooler:.04,case:.02}, constraints:{sff:true, itx:true}},
    { id:2, key:'mini_itx_masterpiece', name:'Mini‑ITX Masterpiece', desc:'Mini‑ITX powerhouse + custom styling.', badge:'Mini‑ITX', budget:[1500,5000], alloc:{cpu:.24,gpu:.38,mb:.09,ram:.07,storage:.09,psu:.06,cooler:.05,case:.02}, constraints:{itx:true, styling:true}},
    { id:3, key:'gaming_perf', name:'Gaming PC — Performance', desc:'1080p/1440p high FPS.', badge:'Gaming', budget:[1200,3000], alloc:{cpu:.22,gpu:.42,mb:.09,ram:.07,storage:.08,psu:.07,cooler:.03,case:.02}, constraints:{}},
    { id:4, key:'gaming_creator', name:'Gaming PC — Creator', desc:'Gaming + creative workloads.', badge:'Gaming/Creator', budget:[1500,3800], alloc:{cpu:.26,gpu:.38,mb:.09,ram:.09,storage:.08,psu:.06,cooler:.03,case:.01}, constraints:{}, flags:{more_ram:true}},
    { id:5, key:'gaming_master', name:'Gaming PC — Master', desc:'4K / max‑settings monster.', badge:'Gaming', budget:[2200,6000], alloc:{cpu:.24,gpu:.46,mb:.08,ram:.07,storage:.06,psu:.05,cooler:.03,case:.01}, constraints:{}},
    { id:6, key:'the_thinker', name:'The Thinker', desc:'AI / heavy CPU compute.', badge:'AI/CPU', budget:[1800,6000], alloc:{cpu:.36,gpu:.24,mb:.10,ram:.12,storage:.08,psu:.06,cooler:.03,case:.01}, constraints:{ecc_ok:true}},
    { id:7, key:'stylistic_intrinsic', name:'Stylistic Intrinsic', desc:'Sleeper: minimal exterior, beautiful internals.', badge:'Sleeper', budget:[1400,4200], alloc:{cpu:.25,gpu:.35,mb:.10,ram:.08,storage:.08,psu:.06,cooler:.05,case:.03}, constraints:{minimal_case:true, rgb:false}},
    { id:8, key:'stylistic_extrinsic', name:'Stylistic Extrinsic', desc:'Hidden cables + beautiful lit exterior.', badge:'Showcase', budget:[1600,4800], alloc:{cpu:.23,gpu:.37,mb:.09,ram:.08,storage:.08,psu:.06,cooler:.05,case:.04}, constraints:{rgb:true, glass_ok:true}},
    { id:9, key:'the_beginner', name:'The Beginner', desc:'First‑time buyers; modular, easy upgrades.', badge:'Beginner', budget:[700,1600], alloc:{cpu:.25,gpu:.30,mb:.12,ram:.10,storage:.10,psu:.08,cooler:.03,case:.02}, constraints:{tool_less:true}, eligibility:'Eligible for 5% Upgrade Program discount.'},
    { id:10, key:'upgrade_program', name:'Upgrade Program', desc:'Program for Tier 9: swap/refresh machines with fees or auto‑refresh @ 24 months (experimental).', badge:'Program', budget:[0,0], alloc:{}, constraints:{program:true}}
  ];

  // Populate tier selector
  const tierSelect = document.getElementById('tierSelect');
  TIERS.forEach(t=>{
    const opt = document.createElement('option');
    opt.value=t.key; opt.textContent=`${t.id}. ${t.name}`; tierSelect.appendChild(opt);
  });
  tierSelect.value = 'gaming_perf';

  const el = (id)=>document.getElementById(id);

  const budgetRange = el('budgetRange');
  const budgetInput = el('budgetInput');
  const markupPct = el('markupPct');
  const assemblyFee = el('assemblyFee');
  const taxPct = el('taxPct');
  const pricingMode = el('pricingMode');

  // init defaults
  budgetRange.value = 1800; budgetInput.value = 1800;

  // sync range & number
  budgetRange.addEventListener('input', e=>{budgetInput.value=e.target.value; updateAllocUI();});
  budgetInput.addEventListener('input', e=>{budgetRange.value=e.target.value; updateAllocUI();});
  tierSelect.addEventListener('change', ()=>{applyTierDefaults(); updateAllocUI();});

  function fmt(n){return `$${Number(n||0).toLocaleString(undefined,{maximumFractionDigits:0})}`}

  function getTier(){return TIERS.find(t=>t.key===tierSelect.value)}

  function applyTierDefaults(){
    const t = getTier();
    el('tierDesc').textContent = t?.desc || '';
    el('tierEligibility').textContent = t?.eligibility || '—';
    if(t && t.budget?.length===2){
      budgetRange.min=t.budget[0]; budgetRange.max=t.budget[1];
      budgetInput.min=t.budget[0]; budgetInput.max=t.budget[1];
      // clamp current value
      let v = Number(budgetInput.value||0); v=Math.min(Math.max(v,t.budget[0]), t.budget[1]||v);
      budgetRange.value=v; budgetInput.value=v;
    }
  }

  function updateAllocUI(){
    const t = getTier(); if(!t||!t.alloc) return;
    const budget = Number(budgetInput.value||0);
    el('kpiCPU').textContent = fmt(budget * (t.alloc.cpu||0));
    el('kpiGPU').textContent = fmt(budget * (t.alloc.gpu||0));
    el('kpiHead').textContent = fmt(budget * ((t.alloc.psu||0)+(t.alloc.cooler||0)));
  }

  applyTierDefaults(); updateAllocUI();

  /*********************
   * Demo / Fallback DB *
   *********************/
  // Minimal demo dataset used when pricingMode === 'manual' or Firestore not ready
  const DEMO_PARTS = [
    {category:'cpu', sku:'RY7_7800X3D', name:'AMD Ryzen 7 7800X3D', socket:'AM5', tdp:120, price_usd:369, perf:95},
    {category:'cpu', sku:'I5_13600K', name:'Intel Core i5‑13600K', socket:'LGA1700', tdp:181, price_usd:289, perf:85},
    {category:'gpu', sku:'RTX_4070_SUPER', name:'NVIDIA GeForce RTX 4070 SUPER 12GB', length_mm:267, price_usd:579, perf:88},
    {category:'gpu', sku:'RTX_4080_SUPER', name:'NVIDIA GeForce RTX 4080 SUPER 16GB', length_mm:304, price_usd:1199, perf:97},
    {category:'mb',  sku:'ASUS_X670E_ITX', name:'ASUS ROG Strix X670E‑I Gaming (Mini‑ITX)', socket:'AM5', form:'Mini‑ITX', price_usd:389},
    {category:'mb',  sku:'MSI_B760_TOMA', name:'MSI B760 Tomahawk WiFi (ATX)', socket:'LGA1700', form:'ATX', price_usd:189},
    {category:'ram', sku:'DDR5_32_6000', name:'32GB (2x16) DDR5‑6000', type:'DDR5', price_usd:115},
    {category:'ram', sku:'DDR5_64_6000', name:'64GB (2x32) DDR5‑6000', type:'DDR5', price_usd:225},
    {category:'storage', sku:'SN850X_2TB', name:'WD Black SN850X 2TB NVMe', type:'NVMe', price_usd:169},
    {category:'psu', sku:'SF750', name:'Corsair SF750 (SFX, 80+ Gold)', watt:750, form:'SFX', price_usd:169},
    {category:'psu', sku:'RM850e', name:'Corsair RM850e (ATX 3.0, 80+ Gold)', watt:850, form:'ATX', price_usd:129},
    {category:'cooler', sku:'NH_L12S', name:'Noctua NH‑L12S (SFF low‑profile)', type:'air', height_mm:70, price_usd:69},
    {category:'cooler', sku:'LS120', name:'Lian Li Galahad II 240 AIO', type:'aio240', height_mm:0, price_usd:109},
    {category:'case', sku:'NR200P', name:'Cooler Master NR200P (Mini‑ITX)', form:'Mini‑ITX', gpu_max:330, cooler_max:155, price_usd:99},
    {category:'case', sku:'LianLi_O11D', name:'Lian Li O11 Dynamic', form:'ATX', gpu_max:420, cooler_max:170, price_usd:139},
  ];

  /********************
   * Firestore Helpers *
   ********************/
  let fb = {app:null, db:null};
  el('btnInitFb').addEventListener('click', ()=>{
    try{
      const cfg = JSON.parse(el('fbConfig').value || '{}');
      fb.app = firebase.initializeApp(cfg);
      fb.db = firebase.firestore();
      el('fbStatus').textContent = 'Initialized ✅';
    }catch(err){
      console.error(err); el('fbStatus').textContent = 'Init failed ❌';
    }
  });

  async function getPartsFromFirestore(category){
    if(!fb.db) return [];
    try{
      const snap = await fb.db.collection('parts').where('category','==',category).get();
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    }catch(e){ console.warn('FS read failed', e); return []; }
  }

  async function getParts(category){
    const mode = pricingMode.value;
    if(mode==='manual') return DEMO_PARTS.filter(p=>p.category===category);
    if(mode==='cached'){
      const fs = await getPartsFromFirestore(category);
      return fs.length? fs : DEMO_PARTS.filter(p=>p.category===category);
    }
    if(mode==='live'){
      // Try cloud function first; fallback to FS/demo
      const ep = el('fnEndpoint').value?.trim();
      try{
        if(ep){
          const res = await fetch(`${ep}?category=${encodeURIComponent(category)}`);
          if(res.ok){ const data = await res.json(); if(Array.isArray(data) && data.length) return data; }
        }
      }catch(e){ console.warn('Live fetch failed, falling back', e); }
      const fs = await getPartsFromFirestore(category);
      return fs.length? fs : DEMO_PARTS.filter(p=>p.category===category);
    }
    return DEMO_PARTS.filter(p=>p.category===category);
  }

  /********************
   * Build Engine v0.3 *
   ********************/
  const CATS = ['cpu','gpu','mb','ram','storage','psu','cooler','case'];

  function estWattage(parts){
    const cpu = parts.cpu?.tdp||95; const gpu = (parts.gpu?.tdp||250);
    const other = 75; return cpu + gpu + other; // very rough
  }

  function compatibleScore(cat, candidate, picked){
    // return {ok:boolean, reason:string}
    const bad = (r)=>({ok:false, reason:r});
    const ok = ()=>({ok:true, reason:'OK'});
    const cpu = picked.cpu; const mb = picked.mb; const gpu = picked.gpu; const kase = picked.case;

    if(cat==='mb' && picked.cpu){ if(candidate.socket && cpu.socket && candidate.socket!==cpu.socket) return bad('Socket mismatch'); }
    if(cat==='cpu' && picked.mb){ if(candidate.socket && mb.socket && candidate.socket!==mb.socket) return bad('Socket mismatch'); }
    if(cat==='ram' && picked.mb){ /* if DDR gen mismatch */ if(candidate.type && picked.mb.ram_type && candidate.type!==picked.mb.ram_type) return bad('RAM type mismatch'); }
    if(cat==='gpu' && picked.case){ if(kase.gpu_max && candidate.length_mm && candidate.length_mm>kase.gpu_max) return bad('GPU too long'); }
    if(cat==='cooler' && picked.case){ if(kase.cooler_max && candidate.height_mm && candidate.height_mm>kase.cooler_max) return bad('Cooler too tall'); }
    if(cat==='psu'){
      const need = estWattage({...picked, [cat]:candidate});
      if(candidate.watt && candidate.watt < Math.ceil(need*1.3)) return bad('Wattage too low (<30% headroom)');
    }
    return ok();
  }

  async function autoBuild(){
    const tier = getTier(); const budget = Number(budgetInput.value||0);
    const alloc = tier.alloc||{}; const picked = {};

    for(const cat of CATS){
      const parts = await getParts(cat);
      const allow = Math.max(1, Math.floor(budget*(alloc[mapCatToAllocKey(cat)]||0.05)));
      // Prefer highest perf under budget; if none, take cheapest compatible
      let best=null, cheapest=null;
      for(const p of parts){
        const price = Number(p.price_usd||p.price||0);
        const score = compatibleScore(cat, p, picked);
        if(!score.ok) continue;
        if(!cheapest || price < (cheapest.price_usd||cheapest.price)) cheapest = p;
        if(price <= allow){
          if(!best || (Number(p.perf||0) > Number(best.perf||0))) best = p;
        }
      }
      picked[cat] = best || cheapest || parts[0] || null;
    }

    renderBuild(picked);
  }

  function mapCatToAllocKey(cat){
    return ({cpu:'cpu', gpu:'gpu', mb:'mb', ram:'ram', storage:'storage', psu:'psu', cooler:'cooler', case:'case'})[cat] || 'misc';
  }

  function renderBuild(parts){
    const tbody = el('buildRows'); tbody.innerHTML='';
    let subtotal = 0; const issues=[];

    for(const cat of CATS){
      const p = parts[cat];
      const tr = document.createElement('tr');
      const price = Number(p?.price_usd||p?.price||0);
      subtotal += (isFinite(price)? price:0);

      let comp = compatibleScore(cat, p||{}, parts);
      tr.innerHTML = `
        <td class="mono">${cat.toUpperCase()}</td>
        <td>${p? (p.name || p.sku || '—') : '—'}<div class="tiny">${p?.sku||''}</div></td>
        <td class="mono">${p? fmt(price):'—'}</td>
        <td class="status ${comp.ok?'good':'warn'}">${comp.reason}</td>
        <td class="tiny">${notesFor(cat, p)||''}</td>`;
      tbody.appendChild(tr);
      if(!comp.ok) issues.push(`${cat}: ${comp.reason}`);
    }

    const markupAmt = subtotal * (Number(markupPct.value||0)/100);
    const preAssembly = subtotal + markupAmt;
    const preTax = preAssembly + Number(assemblyFee.value||0);
    const taxAmt = preTax * (Number(taxPct.value||0)/100);
    const otd = preTax + taxAmt;

    el('kpiParts').textContent = fmt(subtotal);
    el('kpiMarkup').textContent = fmt(markupAmt);
    el('kpiAssembly').textContent = fmt(Number(assemblyFee.value||0));
    el('kpiPretax').textContent = fmt(preTax);
    el('kpiTax').textContent = fmt(taxAmt);
    el('kpiOtd').textContent = fmt(otd);

    if(getTier().id===9){
      el('tierEligibility').textContent = 'Eligible for 5% Upgrade Program discount (Tier 9).';
    }
  }

  function notesFor(cat, p){
    const t = getTier();
    const rgb = el('reqRGB').checked; const sff = el('reqSFF').checked; const liquid = el('reqLiquid').checked; const silent = el('reqSilent').checked;
    const hints=[];
    if(!p) return '';
    if(cat==='case' && sff) hints.push('SFF preferred');
    if(cat==='cooler' && liquid) hints.push('Liquid cooling preferred');
    if(rgb && (cat==='case' || cat==='cooler' || cat==='ram')) hints.push('RGB OK');
    if(silent && (cat==='cooler')) hints.push('Low‑noise');
    if(t.id===6 && cat==='ram') hints.push('Consider 64‑128GB');
    if(t.key==='gaming_creator' && cat==='storage') hints.push('Prefer 2TB+ NVMe');
    return hints.join(' · ');
  }

  // Wire buttons
  el('btnAutoBuild').addEventListener('click', autoBuild);
  el('btnRefreshPrices').addEventListener('click', async()=>{
    // naive refresh: hit function for each category to warm cache
    const ep = el('fnEndpoint').value?.trim(); if(!ep){ alert('Set Cloud Function endpoint first.'); return; }
    for(const c of CATS){ try{ await fetch(`${ep}?category=${encodeURIComponent(c)}`);}catch(e){} }
    alert('Requested live price refresh. If configured, Firestore cache will update.');
  });

  el('btnSaveLocal').addEventListener('click', ()=>{
    const rows = Array.from(document.querySelectorAll('#buildRows tr')).map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {category: tds[0]?.innerText?.trim(), part: tds[1]?.innerText?.trim(), price: tds[2]?.innerText?.trim()}
    });
    const payload = {when: new Date().toISOString(), tier: getTier(), budget:Number(budgetInput.value||0), rows,
      pricing:{markupPct:Number(markupPct.value||0), assembly:Number(assemblyFee.value||0), taxPct:Number(taxPct.value||0)},
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `HRG_build_${Date.now()}.json`; a.click();
  });

  el('btnLoadLocal').addEventListener('click', ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.json'; inp.onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{
        try{
          const data = JSON.parse(r.result);
          tierSelect.value = data?.tier?.key || tierSelect.value; applyTierDefaults();
          budgetRange.value = data?.budget||budgetRange.value; budgetInput.value = budgetRange.value; updateAllocUI();
          markupPct.value = data?.pricing?.markupPct ?? markupPct.value; assemblyFee.value = data?.pricing?.assembly ?? assemblyFee.value; taxPct.value = data?.pricing?.taxPct ?? taxPct.value;
        }catch(e){ alert('Invalid build file.'); }
      }; r.readAsText(f);
    }; document.body.appendChild(inp); inp.click(); inp.remove();
  });

  el('btnExportCSV').addEventListener('click', ()=>{
    const rows = [['Category','Part','Price']];
    document.querySelectorAll('#buildRows tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      rows.push([tds[0]?.innerText?.trim(), (tds[1]?.innerText||'').replace(/\n/g,' '), tds[2]?.innerText?.trim()]);
    });
    const csv = rows.map(r=>r.map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `HRG_build_${Date.now()}.csv`; a.click();
  });

  // Initial demo build to show UI
  autoBuild();
  </script>
</body>
</html>
