import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Upload, Table, Search, Filter, Columns3, Download, Plus, X, Save, Trash2, RefreshCw, KanbanSquare, LayoutList, Database, Users, Building2, Handshake, ChevronDown, ChevronRight, Tag, Mail, Phone, Link2, MapPin, CalendarDays } from "lucide-react";
import * as Papa from "papaparse";
import * as XLSX from "xlsx";

// --- Simple shadcn-like UI wrappers (no external CSS beyond Tailwind) ---
const Button = ({ className = "", children, ...props }) => (
  <button
    className={`inline-flex items-center gap-2 rounded-2xl px-4 py-2 shadow-sm hover:shadow transition border border-slate-200 bg-white text-slate-800 text-sm ${className}`}
    {...props}
  >
    {children}
  </button>
);

const Badge = ({ children, className = "" }) => (
  <span className={`px-2 py-0.5 rounded-full text-xs border ${className}`}>
    {children}
  </span>
);

const Card = ({ className = "", children }) => (
  <div className={`rounded-2xl border border-slate-200 bg-white shadow-sm ${className}`}>{children}</div>
);

const Input = ({ className = "", ...props }) => (
  <input
    className={`w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200 ${className}`}
    {...props}
  />
);

const Textarea = ({ className = "", ...props }) => (
  <textarea
    className={`w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200 ${className}`}
    {...props}
  />
);

const Select = ({ options, value, onChange, className="" }) => (
  <select
    className={`w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200 ${className}`}
    value={value}
    onChange={(e)=>onChange(e.target.value)}
  >
    {options.map(o=> <option key={o.value} value={o.value}>{o.label}</option>)}
  </select>
);

// --- Helpers ---
const uid = () => Math.random().toString(36).slice(2, 10);

const defaultPipelines = {
  Deals: [
    { id: "stage_new", name: "New" },
    { id: "stage_qualify", name: "Qualification" },
    { id: "stage_proposal", name: "Proposal" },
    { id: "stage_negotiate", name: "Negotiation" },
    { id: "stage_won", name: "Closed Won" },
    { id: "stage_lost", name: "Closed Lost" },
  ],
  Leads: [
    { id: "lead_new", name: "New" },
    { id: "lead_contacted", name: "Contacted" },
    { id: "lead_qualified", name: "Qualified" },
    { id: "lead_nurture", name: "Nurturing" },
    { id: "lead_converted", name: "Converted" },
  ],
};

const moduleIcons = {
  Leads: <Users className="w-4 h-4" />,
  Contacts: <Mail className="w-4 h-4" />,
  Accounts: <Building2 className="w-4 h-4" />,
  Deals: <Handshake className="w-4 h-4" />,
};

const guessModule = (row) => {
  const keys = Object.keys(row).map((k) => k.toLowerCase());
  const hasCompany = keys.some((k) => k.includes("company") || k.includes("account"));
  const hasDeal = keys.some((k) => k.includes("deal") || k.includes("amount") || k.includes("stage"));
  const hasPerson = keys.some((k) => k.includes("first") || k.includes("last") || k.includes("name"));
  const hasEmail = keys.some((k) => k.includes("email"));
  if (hasDeal) return "Deals";
  if (hasCompany && !hasPerson) return "Accounts";
  if (hasPerson && hasEmail) return "Contacts";
  return "Leads";
};

const normalizeRow = (row) => {
  // Standardize common CRM fields
  const out = { id: uid(), ...row };
  // Normalize header variants
  const map = {
    name: ["name", "full name", "contact name"],
    first_name: ["first", "first name", "firstname"],
    last_name: ["last", "last name", "lastname"],
    email: ["email", "e-mail"],
    phone: ["phone", "mobile", "cell"],
    company: ["company", "account", "org", "organization"],
    title: ["title", "role", "position"],
    website: ["website", "url"],
    city: ["city"],
    state: ["state", "region", "province"],
    country: ["country"],
    stage: ["stage", "status", "pipeline stage"],
    amount: ["amount", "value", "deal size"],
    notes: ["notes", "note", "comments"],
    source: ["source", "lead source"],
  };
  const lower = Object.fromEntries(
    Object.entries(row).map(([k, v]) => [k.toLowerCase().trim(), v])
  );
  for (const [std, variants] of Object.entries(map)) {
    for (const v of variants) {
      if (lower[v] != null && out[std] == null) {
        out[std] = lower[v];
        break;
      }
    }
  }
  return out;
};

const exportCSV = (rows) => {
  const csv = Papa.unparse(rows);
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `crm_export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};

// --- File parsing ---
async function parseFile(file) {
  const ext = file.name.toLowerCase().split(".").pop();
  if (ext === "csv") {
    return new Promise((resolve, reject) => {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => resolve(res.data.map(normalizeRow)),
        error: reject,
      });
    });
  }
  if (ext === "xlsx" || ext === "xls" || ext === "xlsm" || ext === "xlsb" || ext === "xlam" || ext === "xltx" || ext === "xltm" || ext === "xla") {
    const ab = await file.arrayBuffer();
    const wb = XLSX.read(ab, { type: "array" });
    const first = wb.SheetNames[0];
    const sheet = wb.Sheets[first];
    const json = XLSX.utils.sheet_to_json(sheet);
    return json.map(normalizeRow);
  }
  // Some users say "xlsf" â€“ handle as xlsx alias
  if (ext === "xlsf") {
    const ab = await file.arrayBuffer();
    const wb = XLSX.read(ab, { type: "array" });
    const first = wb.SheetNames[0];
    const sheet = wb.Sheets[first];
    const json = XLSX.utils.sheet_to_json(sheet);
    return json.map(normalizeRow);
  }
  throw new Error("Unsupported file type. Please upload CSV or XLSX.");
}

// --- Data store in localStorage ---
const useLocal = (key, initial) => {
  const [state, setState] = useState(() => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : initial;
    } catch {
      return initial;
    }
  });
  useEffect(() => {
    localStorage.setItem(key, JSON.stringify(state));
  }, [key, state]);
  return [state, setState];
};

// --- Record Detail Drawer ---
const DetailDrawer = ({ record, onClose, onSave }) => {
  const [draft, setDraft] = useState(record);
  useEffect(()=>setDraft(record),[record]);
  if (!record) return null;
  const fields = Object.keys(draft || {}).filter(k => k !== "id");
  return (
    <AnimatePresence>
      {record && (
        <motion.div
          initial={{ x: 400, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          exit={{ x: 400, opacity: 0 }}
          className="fixed right-0 top-0 h-full w-[420px] bg-white border-l border-slate-200 shadow-2xl z-50 flex flex-col"
        >
          <div className="p-4 border-b flex items-center justify-between">
            <div className="font-semibold">Record Details</div>
            <div className="flex items-center gap-2">
              <Button onClick={()=>onSave(draft)} className="bg-indigo-600 text-white border-indigo-600"><Save className="w-4 h-4"/>Save</Button>
              <Button onClick={onClose}><X className="w-4 h-4"/>Close</Button>
            </div>
          </div>
          <div className="p-4 overflow-auto space-y-3">
            {fields.map((f)=> (
              <div key={f}>
                <label className="text-xs text-slate-500">{f}</label>
                <Input value={draft[f] ?? ""} onChange={(e)=>setDraft({...draft,[f]: e.target.value})}/>
              </div>
            ))}
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

// --- Kanban ---
const Kanban = ({ rows, stageKey="stage", stages, onMove, onOpen }) => {
  const columns = stages.map(s => ({...s, items: []}));
  const byId = Object.fromEntries(columns.map(c=>[c.name.toLowerCase(), c]));
  rows.forEach(r => {
    const stage = String(r[stageKey] || "New").toLowerCase();
    const col = byId[stage] || columns[0];
    col.items.push(r);
  });
  return (
    <div className="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-6 gap-4">
      {columns.map(col => (
        <Card key={col.id} className="p-3 min-h-[300px]">
          <div className="flex items-center justify-between mb-2">
            <div className="font-medium flex items-center gap-2"><KanbanSquare className="w-4 h-4"/>{col.name}</div>
            <Badge className="border-slate-200 bg-slate-50 text-slate-600">{col.items.length}</Badge>
          </div>
          <div className="space-y-2">
            {col.items.map(item => (
              <div key={item.id} className="border border-slate-200 rounded-xl p-3 hover:shadow cursor-pointer bg-white" onClick={()=>onOpen(item)}>
                <div className="font-medium text-sm">{item.name || item.first_name || item.company || item.email || "Untitled"}</div>
                <div className="flex flex-wrap gap-2 mt-2 text-xs text-slate-600">
                  {item.amount && <Badge className="border-emerald-200 bg-emerald-50 text-emerald-700">${String(item.amount)}</Badge>}
                  {item.email && <Badge className="border-slate-200 bg-slate-50"><Mail className="w-3 h-3 mr-1 inline"/>{item.email}</Badge>}
                  {item.phone && <Badge className="border-slate-200 bg-slate-50"><Phone className="w-3 h-3 mr-1 inline"/>{item.phone}</Badge>}
                  {item.source && <Badge className="border-sky-200 bg-sky-50 text-sky-700"><Tag className="w-3 h-3 mr-1 inline"/>{item.source}</Badge>}
                </div>
                <div className="flex items-center gap-2 mt-2">
                  <Select
                    className="text-xs"
                    value={String(item[stageKey] || stages[0].name)}
                    onChange={(val)=>onMove(item.id, val)}
                    options={stages.map(s=>({value:s.name, label:s.name}))}
                  />
                </div>
              </div>
            ))}
          </div>
        </Card>
      ))}
    </div>
  );
};

// --- Table ---
const DataTable = ({ rows, columns, onOpen }) => {
  return (
    <div className="overflow-auto">
      <table className="min-w-full text-sm">
        <thead className="sticky top-0 bg-slate-50">
          <tr>
            {columns.map((c) => (
              <th key={c} className="text-left font-medium text-slate-600 px-3 py-2 border-b">{c}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {rows.map((r) => (
            <tr key={r.id} className="hover:bg-slate-50 cursor-pointer" onClick={()=>onOpen(r)}>
              {columns.map((c) => (
                <td key={c} className="px-3 py-2 border-b">
                  {String(r[c] ?? "").slice(0, 120)}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

// --- New Record Modal ---
const Modal = ({ open, title, children, onClose, onSave }) => (
  <AnimatePresence>
    {open && (
      <motion.div className="fixed inset-0 z-50 flex items-center justify-center" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}>
        <div className="absolute inset-0 bg-black/20" onClick={onClose}/>
        <motion.div initial={{scale:.95, opacity:0}} animate={{scale:1, opacity:1}} exit={{scale:.95, opacity:0}} className="relative w-[560px] max-w-[92vw] bg-white rounded-2xl border border-slate-200 shadow-2xl">
          <div className="p-4 border-b flex items-center justify-between">
            <div className="font-semibold">{title}</div>
            <Button onClick={onClose}><X className="w-4 h-4"/>Close</Button>
          </div>
          <div className="p-4">{children}</div>
          <div className="p-4 border-t flex items-center justify-end">
            <Button className="bg-indigo-600 text-white border-indigo-600" onClick={onSave}><Save className="w-4 h-4"/>Save</Button>
          </div>
        </motion.div>
      </motion.div>
    )}
  </AnimatePresence>
);

const QuickForm = ({ fields, onSubmit }) => {
  const [vals, setVals] = useState({});
  return (
    <div className="space-y-3">
      <div className="grid grid-cols-2 gap-3">
        {fields.map((f)=> (
          <div key={f.key} className="col-span-2 sm:col-span-1">
            <label className="text-xs text-slate-500">{f.label}</label>
            <Input value={vals[f.key] || ""} onChange={(e)=>setVals({...vals, [f.key]: e.target.value})}/>
          </div>
        ))}
      </div>
      <div className="flex justify-end">
        <Button className="bg-indigo-600 text-white border-indigo-600" onClick={()=>onSubmit(vals)}><Plus className="w-4 h-4"/>Add</Button>
      </div>
    </div>
  );
};

// --- Main App ---
export default function App() {
  const [module, setModule] = useLocal("crm.module", "Leads");
  const [data, setData] = useLocal("crm.data", { Leads: [], Contacts: [], Accounts: [], Deals: [] });
  const [view, setView] = useLocal("crm.view", "table"); // table | kanban
  const [search, setSearch] = useState("");
  const [detail, setDetail] = useState(null);
  const [showNew, setShowNew] = useState(false);
  const [columns, setColumns] = useLocal("crm.columns", {});

  const allRows = data[module] || [];
  const visibleColumns = useMemo(() => {
    const defaults = ["name","first_name","last_name","email","phone","company","title","stage","amount","source"]; 
    const keys = Array.from(new Set(allRows.flatMap(r => Object.keys(r)).filter(k=>k!=="id")));
    const chosen = columns[module] && columns[module].length ? columns[module] : keys.length ? keys.slice(0,8) : defaults;
    return chosen;
  }, [allRows, columns, module]);

  const filtered = useMemo(() => {
    if (!search) return allRows;
    const q = search.toLowerCase();
    return allRows.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(q)));
  }, [allRows, search]);

  const pipeline = defaultPipelines[module] || defaultPipelines["Leads"]; 
  const stageKey = module === "Deals" ? "stage" : "stage"; // extend if needed

  // Handlers
  const handleImport = async (files) => {
    const results = [];
    for (const file of files) {
      const rows = await parseFile(file);
      rows.forEach(r => {
        const mod = guessModule(r);
        results.push({ ...r, __module: mod });
      });
    }
    const next = { ...data };
    for (const r of results) {
      const m = r.__module || module;
      delete r.__module;
      // de-dupe on email + company + name where possible
      const exists = next[m].some(x => (r.email && x.email && String(x.email).toLowerCase() === String(r.email).toLowerCase()) || (r.name && x.name && String(x.name).toLowerCase() === String(r.name).toLowerCase()));
      if (!exists) next[m] = [...next[m], r];
    }
    setData(next);
  };

  const handleFileInput = async (e) => {
    const files = Array.from(e.target.files || []);
    await handleImport(files);
    e.target.value = "";
  };

  const onMoveStage = (id, newStage) => {
    setData({
      ...data,
      [module]: data[module].map(r => r.id === id ? { ...r, [stageKey]: newStage } : r)
    });
  };

  const onOpen = (record) => setDetail(record);
  const onSaveDetail = (draft) => {
    setData({
      ...data,
      [module]: data[module].map(r => r.id === draft.id ? draft : r)
    });
    setDetail(null);
  };

  const onCreate = (vals) => {
    const rec = normalizeRow(vals);
    setData({ ...data, [module]: [{...rec, id: uid()}, ...data[module]] });
    setShowNew(false);
  };

  const onDeleteAll = () => {
    if (!confirm(`Delete all ${module} records?`)) return;
    setData({ ...data, [module]: [] });
  };

  const onExport = () => exportCSV(data[module]);

  const fileInputRef = useRef(null);

  // Column manager
  const allCols = useMemo(()=>Array.from(new Set(allRows.flatMap(r=>Object.keys(r)).filter(k=>k!=="id"))),[allRows]);
  const [colsOpen, setColsOpen] = useState(false);
  const [colsDraft, setColsDraft] = useState(visibleColumns);
  useEffect(()=>setColsDraft(visibleColumns),[visibleColumns]);

  const topActions = (
    <div className="flex flex-wrap gap-2">
      <Button onClick={()=>fileInputRef.current?.click()}><Upload className="w-4 h-4"/>Import CSV/XLSX</Button>
      <input ref={fileInputRef} type="file" accept=".csv,.xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.xla,.xlsf" className="hidden" multiple onChange={handleFileInput}/>
      <Button onClick={onExport}><Download className="w-4 h-4"/>Export CSV</Button>
      <Button onClick={()=>setShowNew(true)} className="bg-indigo-600 text-white border-indigo-600"><Plus className="w-4 h-4"/>New {module.slice(0,-1)}</Button>
      <Button onClick={()=>setColsOpen(true)}><Columns3 className="w-4 h-4"/>Columns</Button>
      <Button onClick={onDeleteAll} className="text-red-600 border-red-200"><Trash2 className="w-4 h-4"/>Delete All</Button>
      <Button onClick={()=>setView(view==="table"?"kanban":"table")}>
        {view==="table" ? (<><KanbanSquare className="w-4 h-4"/>Kanban</>) : (<><LayoutList className="w-4 h-4"/>Table</>)}
      </Button>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-100 text-slate-900">
      {/* Top Nav */}
      <div className="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-2xl bg-indigo-600 text-white grid place-items-center shadow">
              <Database className="w-5 h-5"/>
            </div>
            <div>
              <div className="font-semibold">Mini CRM</div>
              <div className="text-xs text-slate-500">Zohoâ€‘style â€¢ CSV/XLSX Import â€¢ Kanban â€¢ Table â€¢ Localâ€‘only</div>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="hidden md:flex items-center gap-2 bg-white border border-slate-200 rounded-2xl px-3 py-1.5">
              <Search className="w-4 h-4 text-slate-500"/>
              <input value={search} onChange={(e)=>setSearch(e.target.value)} placeholder="Search recordsâ€¦" className="outline-none text-sm"/>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto p-4 grid grid-cols-12 gap-4">
        {/* Sidebar */}
        <Card className="col-span-12 md:col-span-3 lg:col-span-2 p-3 h-fit sticky top-[68px]">
          <div className="text-xs uppercase tracking-wide text-slate-500 px-2 mb-2">Modules</div>
          <div className="space-y-1">
            {["Leads","Contacts","Accounts","Deals"].map((m)=> (
              <button key={m} onClick={()=>setModule(m)} className={`w-full flex items-center gap-2 px-3 py-2 rounded-xl text-left ${module===m?"bg-indigo-50 border border-indigo-200":"hover:bg-slate-50"}`}>
                <span className="opacity-80">{moduleIcons[m]}</span>
                <span className="flex-1">{m}</span>
                <Badge className="border-slate-200 bg-slate-50 text-slate-600">{data[m]?.length || 0}</Badge>
              </button>
            ))}
          </div>
          <div className="mt-4 p-3 bg-slate-50 rounded-xl border border-slate-200">
            <div className="text-xs text-slate-500 mb-2">Tips</div>
            <ul className="text-xs text-slate-600 list-disc pl-4 space-y-1">
              <li>Click a row/card to edit details.</li>
              <li>Use Kanban to move stage.</li>
              <li>Data stays in your browser.</li>
            </ul>
          </div>
        </Card>

        {/* Main */}
        <div className="col-span-12 md:col-span-9 lg:col-span-10 space-y-4">
          <Card className="p-3 flex flex-wrap items-center justify-between gap-3">
            <div className="flex items-center gap-2">
              <div className="font-semibold">{module}</div>
              <Badge className="border-slate-200 bg-slate-50 text-slate-600">{filtered.length} shown</Badge>
            </div>
            <div className="flex-1 md:hidden">
              <Input placeholder="Searchâ€¦" value={search} onChange={e=>setSearch(e.target.value)}/>
            </div>
            {topActions}
          </Card>

          {view === "table" ? (
            <Card className="p-3">
              <DataTable rows={filtered} columns={visibleColumns} onOpen={onOpen} />
            </Card>
          ) : (
            <Kanban rows={filtered} stageKey={stageKey} stages={pipeline} onMove={onMoveStage} onOpen={onOpen} />
          )}
        </div>
      </div>

      {/* Detail Drawer */}
      <DetailDrawer record={detail} onClose={()=>setDetail(null)} onSave={onSaveDetail} />

      {/* New Record */}
      <Modal open={showNew} title={`New ${module.slice(0,-1)}`} onClose={()=>setShowNew(false)} onSave={()=>{}}>
        <QuickForm
          fields={[
            { key: "name", label: "Name" },
            { key: "first_name", label: "First name" },
            { key: "last_name", label: "Last name" },
            { key: "email", label: "Email" },
            { key: "phone", label: "Phone" },
            { key: "company", label: "Company" },
            { key: "title", label: "Title" },
            { key: "stage", label: "Stage" },
            { key: "amount", label: "Amount" },
            { key: "source", label: "Source" },
            { key: "notes", label: "Notes" },
          ]}
          onSubmit={onCreate}
        />
      </Modal>

      {/* Columns chooser */}
      <Modal open={colsOpen} title={`Columns for ${module}`} onClose={()=>setColsOpen(false)} onSave={()=>{ setColumns({...columns, [module]: colsDraft}); setColsOpen(false); }}>
        <div className="space-y-3">
          <div className="text-sm text-slate-600">Choose up to 10 columns to display in the table view.</div>
          <div className="flex flex-wrap gap-2">
            {allCols.map(c => {
              const on = colsDraft.includes(c);
              return (
                <button key={c} onClick={()=> setColsDraft(on ? colsDraft.filter(x=>x!==c) : [...colsDraft, c].slice(0,10))} className={`px-3 py-1.5 rounded-xl border text-sm ${on?"bg-indigo-50 border-indigo-200":"bg-white border-slate-200"}`}>
                  {c}
                </button>
              );
            })}
          </div>
        </div>
      </Modal>

      {/* Dropzone overlay (optional visual) */}
      <DropOverlay onFiles={handleImport} />
    </div>
  );
}

// --- Global drop overlay for quick importing ---
function DropOverlay({ onFiles }) {
  const [over, setOver] = useState(false);
  useEffect(() => {
    const onDrag = (e) => { e.preventDefault(); e.stopPropagation(); setOver(true); };
    const onLeave = (e) => { e.preventDefault(); e.stopPropagation(); setOver(false); };
    const onDrop = async (e) => { e.preventDefault(); e.stopPropagation(); setOver(false); const files = Array.from(e.dataTransfer.files || []); if (files.length) await onFiles(files); };
    window.addEventListener("dragenter", onDrag);
    window.addEventListener("dragover", onDrag);
    window.addEventListener("dragleave", onLeave);
    window.addEventListener("drop", onDrop);
    return () => {
      window.removeEventListener("dragenter", onDrag);
      window.removeEventListener("dragover", onDrag);
      window.removeEventListener("dragleave", onLeave);
      window.removeEventListener("drop", onDrop);
    };
  }, [onFiles]);

  if (!over) return null;
  return (
    <div className="fixed inset-0 z-40 pointer-events-none">
      <div className="absolute inset-0 bg-indigo-600/10" />
      <div className="absolute inset-0 flex items-center justify-center">
        <div className="pointer-events-auto bg-white border border-indigo-200 shadow-2xl rounded-2xl px-6 py-4 text-center">
          <div className="font-semibold text-indigo-700">Drop CSV/XLSX to import into the CRM</div>
          <div className="text-xs text-slate-600">Weâ€™ll auto-detect module & common fields</div>
        </div>
      </div>
    </div>
  );
}
